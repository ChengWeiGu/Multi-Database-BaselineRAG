<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SR Copilot Demo</title>
    <!-- 引入 CSS 文件 -->
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <h1 id = "header">Weintek Service Request Copilot (Demo)</h1>
    <div id="rag_model_div">
        <label for="select_rag_model">Select Copilot Model: </label>
        <select id="select_rag_model" name="select_rag_model">
            <option value="baseline1">QA Retrieval</option>
            <option value="baseline2" selected>QA + Document Retrieval (recommend)</option>
        </select>
    </div>

    <div id="rag_generate_model_div">
        <label for="select_generate_model">Select Generate Model: </label>
        <select id="select_generate_model" name="select_generate_model">
            <option value="gpt35">gpt-3.5-turbo </option>
            <option value="gpt4" selected>gpt-4-turbo (recommend)</option>
        </select>
        <p> - Notice: GPT-3.5 may be faster than GPT-4, but the content generated by GPT-4 will be richer.</p>
    </div>

    <div id="qa_container" class="container">
        <form id="text_form">
            <label for="input_text">Input Text (Query):</label>
            <textarea id="input_text" name="input_text" placeholder="Input your question&#10;ex1: How to install EBPro on my PC?&#10;ex2: 如何設定與使用EasyBuilder Pro的MQTT物件?用中文回答&#10;&#10;Hint: Every submit could generate different responses"></textarea>
        </form>
        <span id="separator">&gt;&gt;</span>
        <div id="output_text_div">
            <label for="output_text">Output Text (Generation):</label>
            <textarea id="output_text" readonly></textarea>
        </div>

        <div id="feedback_div">
            <div>
                <label for="select_score">Score:</label>
                <select id="select_score" name="select_score">
                    {% for i in range(1,11) %}
                        <option value="{{i}}" {% if i == 10 %}selected{% endif %}>{{i}}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="select_assist">Assist FAE in response?</label>
                <select id="select_assist" name="select_assist">
                    <option value="Y">Y</option>
                    <option value="N">N</option>
                </select>
            </div>
            <div>
                <label for="select_OK">Generation is OK?</label>
                <select id="select_OK" name="select_OK">
                    <option value="Y">Y</option>
                    <option value="N">N</option>
                </select>
            </div>
            <div>
                <label for="input_text_feedback">Feedback: </label>
                <textarea id="input_text_feedback" name="input_text_feedback" placeholder = "留下您寶貴的意見，例如答案與問題是否有相關性，或建議更好的回答，或需要其它經驗進行答覆。&#10;Please leave your valuable feedback, such as whether the answers are relevant to the questions, suggestions for better responses, or if other experiences are needed to answer."></textarea>
                <button id="send_button">Send</button>
            </div>

        </div>
    </div>
    <div id="button_div">
        <button id="submit_button">Submit</button>
    </div>

    <div id = "qa_retrieve_container" class="container">
        <div id="qa_retrieve_div">
            <label for="sr_qa_text" id='sr_qa_label'>Retrieved QA:</label>
            <textarea id="sr_qa_text" readonly></textarea>
        </div>
        <div id="qa_hyperLink_div">
            <label for="elementList" id='linkList_label'>Retrieved Hyper Link:</label>
            <ul id="elementList"></ul>
        </div>
    </div>
    
    <div id="doc_retrieve_div">
        <label for="doc_text" id="doc_label">Retrieved Documents:</label>
        <textarea id="doc_text" readonly></textarea>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@3.0.7/marked.min.js"></script>
    <script>
        document.getElementById('send_button').addEventListener('click', function() {
            var select_score = document.getElementById('select_score');
            var select_assist = document.getElementById('select_assist');
            var select_OK = document.getElementById('select_OK');
            var input_text_feedback = document.getElementById('input_text_feedback');
            var userAgent = navigator.userAgent;
            var platform = navigator.platform;
            var username = localStorage.getItem('username');
            var inputText = document.getElementById('input_text');
            var output_text = document.getElementById('output_text');
            var sr_qa_text = document.getElementById('sr_qa_text');
            var doc_text = document.getElementById('doc_text');
            var select_rag_model = document.getElementById('select_rag_model');
            var select_generate_model = document.getElementById('select_generate_model');
            fetch('feedback',{
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({score : select_score.value,
                                    assist : select_assist.value,
                                    is_OK : select_OK.value,
                                    feedback : input_text_feedback.value,
                                    userAgent : userAgent,
                                    platform : platform,
                                    username : username,
                                    query : inputText.value,
                                    generation : output_text.value,
                                    qa_retrieval : sr_qa_text.value,
                                    doc_retrieval : doc_text.value,
                                    retrieval_rag_model : select_rag_model.value,
                                    retrieval_generate_model : select_generate_model.value
                                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status == 'success'){
                    alert("Send Successifully");
                } else {
                    alert(data.error_reason);
                }   
            })
        })

        document.getElementById('submit_button').addEventListener('click', function() {
            //隱藏搜索結果
            document.getElementById('qa_retrieve_div').style.display = 'none';
            document.getElementById('doc_retrieve_div').style.display = 'none';
            document.getElementById('qa_hyperLink_div').style.display = 'none';
            //定義變數
            var inputText = document.getElementById('input_text').value;
            var sr_qa_text_box = document.getElementById('sr_qa_text');
            var doc_text_box = document.getElementById('doc_text');
            var output_text_box = document.getElementById('output_text');
            var submit_button = document.getElementById('submit_button');
            var select_rag_model = document.getElementById('select_rag_model');
            var select_generate_model = document.getElementById('select_generate_model');
            var send_button = document.getElementById('send_button');
            submit_button.disabled = true;
            send_button.disabled = true;
            output_text_box.value = 'Generating...';
            output_text_box.classList.add('spinner');
            
            output_text_box.style.fontSize = "20px"
            var loadingInterval = setInterval(function(){
                output_text_box.value += '..';
                if (output_text_box.value.length > 50) {
                    output_text_box.value = 'Generating...';
                }
            },500);

            fetch('/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ input_text: inputText ,
                                        select_rag_model : select_rag_model.value,
                                        select_generate_model : select_generate_model.value
                                    })
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(loadingInterval);
                output_text_box.value = data.output_text;
                sr_qa_text_box.value = data.qa_text_body;
                doc_text_box.value = data.doc_text_body;
                if (data.status == 'success'){
                    if (sr_qa_text_box.value != '') {
                        document.getElementById('qa_retrieve_div').style.display = 'flex';
                        document.getElementById('qa_hyperLink_div').style.display = 'flex';
                        displayElements(data.qa_retrieved_ids);
                    }
                    //延遲1秒顯示
                    if (doc_text_box.value != ""){
                        setTimeout(function() {
                            document.getElementById('doc_retrieve_div').style.display = 'flex';
                        },1.0)
                    }
                }
                
                output_text_box.classList.remove('spinner');
                submit_button.disabled = false;
                send_button.disabled = false;
                output_text_box.style.fontSize = "14px"
            })
            .catch(error => {
                console.error('Error:', error);
                clearInterval(loadingInterval);
                output_text_box.classList.remove('spinner');
                submit_button.disabled = false;
                send_button.disabled = false;
                output_text_box.style.fontSize = "14px";
                output_text_box.value = error.message;
            });
        });

        function displayElements(qa_retrieved_ids) {
            var elementList = document.getElementById('elementList');
            elementList.innerHTML = '';
            qa_retrieved_ids.forEach((element, index) => {
                var listItem = document.createElement('li');
                var link = document.createElement('a');
                link.href = "https://datacenter.weintek.com:4300/M_ServiceRequest/M_SRMain.aspx?SR_Uid=" + element.slice(0,-2)
                link.textContent = "Ref Q"+(index+1)+" : "+element
                link.target = "_blank"; //打開新分頁
                listItem.appendChild(link)
                elementList.appendChild(listItem)
            });
        }

        function TxtContent2Markdown(textContent) {
            var output_text_div = document.getElementById('output_text_div');
            // Define a regular expression to match code blocks
            var codeRegex = /```[\s\S]*?```/g;
            // Replace code blocks with Markdown style
            var markdownContent = textContent.replace(codeRegex, function(match) {
                return '<div class="markdown-code">' + match + '</div>';
            });
            htmlContent = '<div id=exclude_code_div>' + markdownContent + '</div>';
            // Convert Markdown content to HTML
            //var htmlContent = marked(markdownContent);
            // Display the HTML content
            output_text_div.innerHTML  = htmlContent;
        }

    </script>
</body>
</html>
